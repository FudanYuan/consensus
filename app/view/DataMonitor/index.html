{include file="Common/top" title="首页" metas='' /}
{include file="Common/search" /}
<div class="main-container">
    <div class="padding-md" style="overflow: auto">
        <ul class="breadcrumb">
            <li><span class="primary-font"><i class="icon-home"></i></span><a href="__PRO_PATH__/">首页</a></li>
            <li>实时舆情</li>
            <li>全部舆情</li>
        </ul>

        <!-- 搜索条件 -->
        <div class="list-search">
            <form action="" class="form-inline" method="get" id="main-form" >
                <div class="form-group">
                    <label>时间范围：</label>
                    <input type="text" class="form-control date-picker" id="dateTimeRange" value="" style="width: 190px"/>
                    <input type="hidden" name="begintime_str" id="begintime_str" value=""/>
                    <input type="hidden" name="endtime_str" id="endtime_str" value=""/>
                </div>
                <div class="form-group">
                    <label for="relevance">舆情状态：</label>
                    <div class="btn-group" data-toggle="buttons" id="relevance">
                        <label class="btn btn-success" id="relevance-1" onclick="getRadioClicked('relevance', 0, -1)">
                            <input type="radio" name="relevance" value="-1" checked>全部
                        </label>
                        <label class="btn btn-default" id="relevance0" onclick="getRadioClicked('relevance', 1, 0)">
                            <input type="radio" name="relevance" value="0">相关性强
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="nature">舆情属性：</label>
                    <div class="btn-group" data-toggle="buttons" id="nature">
                        <label class="btn btn-success" id="nature-1" onclick="getRadioClicked('nature', 0, -1)">
                            <input type="radio" name="nature" value="-1" checked>全部
                        </label>
                        <label class="btn btn-default" id="nature0" onclick="getRadioClicked('nature', 1, 0)">
                            <input type="radio" name="nature" value="0">正面
                        </label>
                        <label class="btn btn-default" id="nature1" onclick="getRadioClicked('nature', 2, 1)">
                            <input type="radio" name="nature" value="1">中立
                        </label>
                        <label class="btn btn-default" id="nature2" onclick="getRadioClicked('nature', 3, 2)">
                            <input type="radio" name="nature" value="2">负面
                        </label>
                    </div>
                </div>

                <br/><br/>
                <div class="form-group">
                    <label for="area">地域选择：</label>
                    <select name="area" class="form-control" id="area" style="width:100px">
                        <option value="-1">全部</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="media_type">媒体类型：</label>
                    <select name="media_type" class="form-control" id="media_type" style="width:100px">
                        <option value="-1">全部</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="keywords">关键词：</label>
                    <input name="keywords" class="form-control" id="keywords" style="width:150px" value=""/>
                </div>

                <div class="form-group">
                    <input type="hidden" name="sortCol" class="form-control" id="sortCol"
                           value="{$cond.sortCol ?? ''}">
                </div>

                {if condition="authority('MonitorData_export')"}
                <a href="__PRO_PATH__/DataMonitor/export" target="_blank" type="button"
                   class="btn btn-default fr">导出</a>
                {/if}
            </form>
        </div>

        <!-- 数据表 -->
        <table class="table table-hover" style="background:#fff;" id="data">
            <thead>
            <tr>
                <th>标题</th>
                <th>来源</th>
                <th>媒体类型</th>
                <th>舆情属性</th>
                <th>发表时间
                    <a href="javascript:;" id="sort_time" onclick="setSortCol('time')" title="asc">
                        <i class="fa fa-sort" aria-hidden="true"></i>
                    </a>
                </th>
                <th>关联度
                    <a href="javascript:;" id="sort_relevance" onclick="setSortCol('relevance')" title="asc">
                        <i class="fa fa-sort" aria-hidden="true"></i>
                    </a>
                </th>
                <th>相似文章
                    <a href="javascript:;" id="sort_similar_num" onclick="setSortCol('similar_num')" title="asc">
                        <i class="fa fa-sort" aria-hidden="true"></i>
                    </a>
                </th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
                <tr v-for="model in list">
                    <td hidden><input type="checkbox" name="select" :value="model.id"/></td>
                    <td>{{model.title}}</td>
                    <td>{{model.source}}</td>
                    <td>{{model.media_type}}</td>
                    <td>{{model.nature}}</td>
                    <td>{{model.publishtime | moment}}</td>
                    <td :title="model.relevance">
                        <div id="bg"><!--这里是背景，也就是灰色的星星-->
                            <!--说明，这里的width就是设置分数啦，以我写的为例，一个星星的长度是12px，也就是1分12px，如果是4.3分，就是4.3*12px = 51.6px的长度，当然这个一般是取得数据后用js或者其他模板语言去控制的-->
                            <div id="over" :style="{ width: model.relevance * 6 + 'px' }"></div><!--这里是遮罩，设置宽度以达到评分的效果-->
                        </div>
                    </td>
                    <td>{{model.similar_num}}</td>
                    <td>
                        {if condition="authority('Data_collect')"}
                        <a href="javascript:;" @click="dataCollect(model.id, model.is_collect)">
                            <i :class="['fa fa-heart', model.is_collect ? 'collected' : '']" aria-hidden="true" :id="'collect_' + model.id" style= "margin-right: 5px"></i>
                        </a>
                        {/if}

                        {if condition="authority('Data_edit')"}
                        <a href="javascript:;" @click="dataEdit(model.id)"><i class="fa fa-pencil-square-o" aria-hidden="true" style="margin-right: 5px;"></i></a>
                        {/if}

                        {if condition="authority('Data_remote')"}
                        <a href="javascript:;" id="removeItem"><i class="fa fa-trash" aria-hidden="true" style="margin-right: 5px;"></i></a>
                        {/if}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div><!-- /main-container -->
{include file="Common/popup_warn" /}
{include file="Common/popup_list" /}
{include file="Common/calendar" /}
{include file="Common/bottom" /}
<script src="__PUBLIC__/js/datapicker/daterangepicker.js"></script>
<script>
    $('#consensus-nav-monitor').addClass('active open');
    $('#consensus-nav-monitor-sub1').addClass('active');
    // 时间选择器
    $(function () {
        $('#dateTimeRange')
                .daterangepicker({
                    applyClass: 'btn-sm btn-success',
                    cancelClass: 'btn-sm btn-default',
                    locale: {
                        applyLabel: '确认',
                        cancelLabel: '取消',
                        fromLabel: '起始时间',
                        toLabel: '结束时间',
                        customRangeLabel: '自定义',
                        daysOfWeek: ['日', '一', '二', '三', '四', '五', '六'],
                        monthNames: ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'],
                        firstDay: 1
                    },
                    ranges: {
                        '今日': [moment().startOf('day'), moment()],
                        '昨日': [moment().subtract(1, 'days').startOf('day'), moment().subtract(1, 'days').endOf('day')],
                        '最近7日': [moment().subtract(6, 'days'), moment()],
                        '最近30日': [moment().subtract(29, 'days'), moment()],
//                        '本月': [moment().startOf("month"), moment().endOf("month")],
//                        '上个月': [moment().subtract(1, "month").startOf("month"), moment().subtract(1, "month").endOf("month")],
//                        '最近90日': [moment().subtract('days', 89), moment()],
//                        '本季度': [moment().startOf("quarter"), moment()],
//                        '上个季度': [moment().subtract(1, "quarter").startOf("quarter"), moment().subtract(1, "quarter").endOf("quarter")],
//                        '今年': [moment().startOf("year"), moment()],
//                        '去年': [moment().subtract(1, "year").startOf("year"), moment().subtract(1, "year").endOf("year")]
                    },
                    opens: 'center',    // 日期选择框的弹出位置
                    separator: ' 至 ',
                    showWeekNumbers: true,     // 是否显示第几周

                    //timePicker: true,
                    //timePickerIncrement : 10, // 时间的增量，单位为分钟
                    //timePicker12Hour : false, // 是否使用12小时制来显示时间

                    maxDate: moment(),           // 最大时间
                    format: 'YYYY-MM-DD'

                }, function (start, end, label) { // 格式化日期显示框
                    $('#begintime_str').val(start.format('YYYY-MM-DD'));
                    $('#endtime_str').val(end.format('YYYY-MM-DD'));
                }).next().on('click', function () {
            $(this).prev().focus();
        });
    });
    $('#sortCol').val('time');
    var sort = $('#sortCol').val();
    getSortCol(sort);
    var params = {};

    submit();

    // 转化时间
    Vue.filter('moment', function (value, formatString) {
        formatString = formatString || 'YYYY-MM-DD HH:mm:ss';
        return new Date(parseInt(value) * 1000).toLocaleString().replace(/年|月/g, "-").replace(/日/g, " ");
    });

    // 异步提交数据
    function submit() {
        getParams();
        $.post('__PRO_PATH__/DataMonitor/getPublicList', params, function (res) {
            if (res.errorcode == 0) {
                params = res.params;
                var data = res.data;
                new Vue({
                    el: '#data',
                    data: {
                        list: data
                    }
                });
            } else {
                new Vue({
                    el: '#data',
                    data: {
                        list: {}
                    }
                });
            }
        });
    }

    // 获取点击按钮
    function getRadioClicked(name, index, value) {
        var valueOld = $("input[name="+name+"]:checked").val();
        var eleOld = name + valueOld;
        $('#'+eleOld).removeClass('btn-success').addClass('btn-default');
        $('input[name='+name+']').eq(index).attr('checked', 'true');
        var eleNew = name + value;
        $('#'+eleNew).removeClass('btn-default').addClass('btn-success');
    }

    // 获取参数设置
    function getParams() {
        var data = $('#main-form').serializeArray();
        $.each(data, function () {
            params[this.name] = this.value;
        });
        console.log(JSON.stringify(params));
    }

    // 改变排序方向
    function changeSort(sort) {
        if (sort == 'asc') {
            return 'desc';
        } else {
            return 'asc';
        }
    }

    // 设置排序参数
    function setSortCol(col) {
        var sort = $('#sortCol');
        var title;
        switch (col) {
            case 'time':
                title = $("#sort_t1").attr('title');
                sort.val("e.name " + title);
                $("#sort_t1").attr({"title": changeSort(title)});
                $("#sort_t1 i").removeClass().addClass('fa fa-sort-' + changeSort(title));
                break;
            case 'relevance':
                title = $("#sort_t2").attr('title');
                sort.val("d.name " + title);
                $("#sort_t2").attr({"title": changeSort(title)});
                $("#sort_t2 i").removeClass().addClass('fa fa-sort-' + changeSort(title));
                break;
            case 'similar_num':
                title = $("#sort_t3").attr('title');
                sort.val("c.name " + title);
                $("#sort_t3").attr({"title": changeSort(title)});
                $("#sort_t3 i").removeClass().addClass('fa fa-sort-' + changeSort(title));
                break;
        }
        submit();
    }

    // 获取排序参数
    function getSortCol(sortcol) {
        var col = sortcol.split(' ');
        var title = col[1];
        switch (col[0]) {
            case 'a.id':
                $("#sort_id").attr({"title": changeSort(title)});
                $("#sort_id i").removeClass().addClass('fa fa-sort-' + changeSort(title));
                break;
            case 'b.name':
                $("#sort_c_name").attr({"title": changeSort(title)});
                $("#sort_c_name i").removeClass().addClass('fa fa-sort-' + changeSort(title));
                break;
            case 'e.name':
                $("#sort_t1").attr({"title": changeSort(title)});
                $("#sort_t1 i").removeClass().addClass('fa fa-sort-' + changeSort(title));
                break;
            case 'd.name':
                $("#sort_t2").attr({"title": changeSort(title)});
                $("#sort_t2 i").removeClass().addClass('fa fa-sort-' + changeSort(title));
                break;
            case 'c.name':
                $("#sort_t3").attr({"title": changeSort(title)});
                $("#sort_t3 i").removeClass().addClass('fa fa-sort-' + changeSort(title));
                break;
            case 'a.task_id':
                $("#sort_task_id").attr({"title": changeSort(title)});
                $("#sort_task_id i").removeClass().addClass('fa fa-sort-' + changeSort(title));
                break;
            case 'a.createtime':
                $("#sort_time").attr({"title": changeSort(title)});
                $("#sort_time i").removeClass().addClass('fa fa-sort-' + changeSort(title));
                break;
        }
    }

    // 收藏
    function dataCollect(id, isCollected) {
        console.log(id + ' ' + isCollected);
        $.post('__PRO_PATH__/DataMonitor/doCollect', {'id': id, 'is_collect' : isCollected}, function (res) {
            if(res.errorcode == 0){
                submit();
            } else {
                popWarn(res.msg);
            }
        });
    }

    // 删除
    popupList({
        remove: '__PRO_PATH__/DataMonitor/remove'
    });

    setInterval(function () {
        submit();
    }, 1000);
</script>
